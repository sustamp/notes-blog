---
layout: post-custom
title: "代码漏洞与解决方案"
---

## SQL注入

SQL注入是指攻击者将SQL命令嵌入到web表单、http请求的字符串参数中，使得服务器在数据库执行SQL语句的行为。

### 解决方案
1. 参数化查询：
   - **使用参数化sql语句**：通过**预编译SQL语句**并传递参数，可以有效防止SQL注入。
   - **使用存储过程**执行所有的查询：调用存储过程也是参数化传递的。
2. 请求参数校验：
   - **正则表达式**：例如邮箱地址、手机号、身份证号等，通过正则表达式进行校验。
   - 用户输入的**合法性检查**：检查输入的数据类型或格式，确保其符合预期。例如年龄是否为数字。
   - 敏感字符串**黑名单**：禁止某些特定的字符串与关键字出现在用户输入中。


## XSS攻击

XSS(Cross Site Scripting)跨站脚本攻击，是指攻击者利用Web服务器中的应用程序或代码漏洞，在页面中嵌入客户端脚本（通常是一段JavaScript编写的恶意代码），当信任此Web服务器的用户访问Web站点中含有恶意代码的页面或打开收到的URL链接时，用户浏览器会自动加载并执行恶意代码，以达到攻击的目的。

XSS分为反射性、存储型和DOM型。

### 存储型XSS攻击

存储型XSS又叫持久性XSS，XSS代码被攻击者存储到服务器中，因此用户在访问含有持久性XSS代码的网站就会被攻击。

### 反射性XSS攻击

反射型XSS是指应用程序通过Web请求获取不可信赖的数据，并在未检验数据是否存在恶意代码的情况下，将其发送给用户。反射型XSS一般可以由攻击者构造带有恶意代码参数的URL来实现，在构造的URL地址被打开后，其中包含的恶意代码参数被浏览器解析和执行。这种攻击的特点是非持久化，必须用户点击包含恶意代码参数的链接时才会触发。

### 修复建议

为了避免反射型XSS攻击，建议采用以下方式进行防御：
1. 对用户的输入进行合理验证（如年龄只能是数字），对特殊字符（如`<、>、'、"`以及`<script>、javascript`等进行过滤。
2. 根据数据将要置于HTML上下文中的不同位置（HTML标签、HTML属性、JavaScript脚本、CSS、URL），对所有不可信数据进行恰当的输出编码。
3. 设置HttpOnly属性，避免攻击者利用跨站脚本漏洞进行Cookie劫持攻击。在Java EE中，给Cookie添加HttpOnly的代码如下：
    ```
    //java
    response.setHeader("Set-Cookie","cookiename=cookievalue; path=/; Domain=domainvaule; Max-age=seconds; HttpOnly");
    ```
        
Spring使用过滤器防御XSS攻击。

## 路径遍历

应用程序对用户可控制的输入未经合理校验，就传送给一个文件API。攻击者可能会使用一些特殊的字符（如`..`和`/`）摆脱受保护的限制，访问一些受保护的文件或目录。

攻击者可能提供类似下面的输入：
`/safe_dir/../important.dat`
程序假定路径是有效的，因为它是以`/safe_dir/`开头的，但是`../`将导致程序删除`important.dat`文件的父目录。

### 修复建议

预防路径遍历的威胁，有以下三种方法：
  1. 程序对非受信的用户输入做过滤和验证，对网站用户提交的文件路径进行硬编码或统一编码，过滤非法字符。
  2. 对文件后缀进行白名单控制，拒绝包含了恶意的符号或空字节。
  3. 合理配置Web服务器的目录访问权限。

有关apache的commons-io，使用FileUtils工具包的代码，好像也没有解决。(或需要ver 2.6或以上版本才行？)

